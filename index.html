<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frederick Business Directory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.3.2/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .ag-theme-alpine {
            height: 600px;
        }
        
        .cell-link {
            color: #0d6efd;
            text-decoration: none;
        }
        
        .cell-link:hover {
            text-decoration: underline;
        }
        
        .category-tag {
            display: inline-block;
            margin: 1px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header text-center py-5">
            <div class="container">
                <h1 class="display-4 fw-light mb-3">Frederick Business Directory</h1>
                <p class="lead mb-4">Comprehensive listing of businesses in Frederick, Maryland</p>
                <div class="row justify-content-center">
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <div class="stat-number" id="business-count">-</div>
                            <div class="text-white-50">Businesses</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center">
                            <div class="stat-number" id="category-count">-</div>
                            <div class="text-white-50">Categories</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container-fluid my-4">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="text-center mb-4" id="loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">Loading business data...</div>
                            </div>
                            <div style="display: none;" id="grid-section">
                                <div class="row mb-3">
                                    <div class="col-md-6 col-lg-4 mx-auto">
                                        <div class="input-group">
                                            <span class="input-group-text">üîç</span>
                                            <input 
                                                type="text" 
                                                id="quickFilter" 
                                                class="form-control" 
                                                placeholder="Search businesses, categories, addresses..."
                                                autocomplete="off"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div id="myGrid" class="ag-theme-alpine"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="bg-light text-center py-4 mt-5">
            <div class="container">
                <p class="text-muted mb-1">Data sourced from Frederick Chamber of Commerce, Discover Frederick, Made in Frederick, and other local business directories.</p>
                <p class="text-muted mb-0">Last updated: <span id="last-updated">-</span></p>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        let gridApi;
        let businesses = [];
        let businessCategories = [];
        let addresses = [];
        let allCategoryNames = [];

        // Column definitions for AG Grid
        const columnDefs = [
            { 
                field: "name", 
                headerName: "Business Name",
                filter: true,
                sortable: true,
                flex: 2,
                cellRenderer: function(params) {
                    if (params.data.website_url) {
                        return `<a href="${params.data.website_url}" target="_blank" class="cell-link">${params.value}</a>`;
                    }
                    return params.value;
                }
            },
            { 
                field: "categoryNames", 
                headerName: "Categories",
                filter: 'agSetColumnFilter',
                filterParams: {
                    excelMode: 'mac',
                    values: function(params) {
                        return allCategoryNames;
                    }
                },
                flex: 2,
                cellRenderer: function(params) {
                    if (params.value && params.value.length > 0) {
                        return params.value.map(cat => 
                            `<span class="badge bg-primary category-tag">${cat}</span>`
                        ).join(' ');
                    }
                    return '';
                }
            },
            { 
                field: "fullAddress", 
                headerName: "Address",
                filter: true,
                flex: 2
            },
            { 
                field: "number_of_employees", 
                headerName: "Employees",
                filter: 'agNumberColumnFilter',
                sortable: true,
                width: 120,
                cellRenderer: function(params) {
                    if (params.value) {
                        return params.value.toLocaleString();
                    }
                    return '';
                }
            },
            { 
                field: "phone_numbers", 
                headerName: "Phone",
                filter: true,
                width: 150,
                cellRenderer: function(params) {
                    if (params.value && params.value.length > 0) {
                        return params.value[0];
                    }
                    return '';
                }
            }
        ];

        // Grid options
        const gridOptions = {
            columnDefs: columnDefs,
            defaultColDef: {
                resizable: true,
                sortable: true,
                filter: true
            },
            pagination: true,
            paginationPageSize: 50,
            paginationPageSizeSelector: [25, 50, 100, 200],
            rowSelection: 'single',
            animateRows: true
        };

        // Initialize the grid
        document.addEventListener('DOMContentLoaded', function () {
            const gridDiv = document.querySelector('#myGrid');
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
            
            // Load the data
            loadData();
        });

        async function loadData() {
            try {
                // Fetch the YAML file
                const response = await fetch('./db.yaml');
                const yamlText = await response.text();
                
                // Parse YAML
                const data = jsyaml.load(yamlText);
                
                // Process the data
                processData(data);
                
                // Hide loading and show grid
                document.getElementById('loading').style.display = 'none';
                document.getElementById('grid-section').style.display = 'block';
                
                // Setup quick filter
                setupQuickFilter();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').textContent = 'Error loading data. Please try again later.';
            }
        }

        function processData(data) {
            // Separate data by model type
            addresses = data.filter(item => item.model === 'app.address');
            businessCategories = data.filter(item => item.model === 'app.businesscategory');
            businesses = data.filter(item => item.model === 'app.business');
            
            // Create lookup maps for efficiency
            const addressMap = {};
            addresses.forEach(addr => {
                addressMap[addr.pk] = addr.fields;
            });
            
            const categoryMap = {};
            businessCategories.forEach(cat => {
                categoryMap[cat.pk] = cat.fields;
            });
            
            // Process businesses data for the grid
            const processedBusinesses = businesses.map(business => {
                const fields = business.fields;
                
                // Get address information
                let fullAddress = '';
                if (fields.address && addressMap[fields.address]) {
                    const addr = addressMap[fields.address];
                    const parts = [addr.street_1, addr.city, addr.state, addr.zip].filter(Boolean);
                    fullAddress = parts.join(', ');
                }
                
                // Get category names
                const categoryNames = [];
                if (fields.categories && fields.categories.length > 0) {
                    fields.categories.forEach(catId => {
                        if (categoryMap[catId]) {
                            const catName = categoryMap[catId].name;
                            categoryNames.push(catName);
                            // Collect all unique category names
                            if (!allCategoryNames.includes(catName)) {
                                allCategoryNames.push(catName);
                            }
                        }
                    });
                }
                
                return {
                    ...fields,
                    id: business.pk,
                    fullAddress: fullAddress,
                    categoryNames: categoryNames
                };
            });
            
            // Sort category names alphabetically
            allCategoryNames.sort();
            
            // Set the grid data
            gridApi.setGridOption('rowData', processedBusinesses);
            
            // Update stats
            document.getElementById('business-count').textContent = businesses.length.toLocaleString();
            document.getElementById('category-count').textContent = businessCategories.length.toLocaleString();
            
            // Find the most recent update date
            const allDates = [...businesses, ...businessCategories, ...addresses]
                .map(item => new Date(item.fields.updated_at || item.fields.created_at))
                .filter(date => !isNaN(date));
            
            if (allDates.length > 0) {
                const lastUpdate = new Date(Math.max(...allDates));
                document.getElementById('last-updated').textContent = lastUpdate.toLocaleDateString();
            }
        }

        function setupQuickFilter() {
            const quickFilterInput = document.getElementById('quickFilter');
            
            quickFilterInput.addEventListener('input', function(e) {
                gridApi.setGridOption('quickFilterText', e.target.value);
            });
            
            // Clear search with Escape key
            quickFilterInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    e.target.value = '';
                    gridApi.setGridOption('quickFilterText', '');
                }
            });
        }
    </script>
</body>
</html>